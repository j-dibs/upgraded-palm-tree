<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Personal Reference Manager</title>
  <style>
    :root{
      --navy:#0b1e3f;
      --navy-700:#0f2a5c;
      --navy-600:#173a7a;
      --orange:#ff7a1a;
      --bg:#f7f8fb;
      --card:#ffffff;
      --text:#101113;
      --muted:#5a6472;
      --focus:#ffd36a;
      --border:#e2e8f0;
      --success:#1f9d55;
      --danger:#b42318;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif; color:var(--text); background:var(--bg);
      line-height:1.4;
    }
    a{color:var(--orange)}
    .container{max-width:1100px; margin-inline:auto; padding:24px}
    header{
      background:linear-gradient(0deg,var(--navy-700),var(--navy));
      color:white; padding:28px 20px; position:sticky; top:0; z-index:5; border-bottom:4px solid var(--orange);
    }
    header .brand{display:flex; align-items:center; gap:12px}
    .brand .mark{width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg,var(--orange),#ffd36a); display:inline-block}
    .brand h1{font-size:20px; margin:0}

    nav{margin-top:16px; display:flex; gap:8px; flex-wrap:wrap}
    .btn{
      appearance:none; border:none; cursor:pointer; border-radius:12px; padding:10px 14px; font-weight:600;
      transition:transform .04s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--orange); color:#0b0b0b}
    .btn.secondary{background:#fff; color:var(--navy-700); border:1px solid var(--border)}
    .btn.ghost{background:transparent; color:#fff; border:1px solid rgba(255,255,255,.2)}
    .btn.danger{background:var(--danger); color:#fff}
    .btn.success{background:var(--success); color:#fff}
    .btn:focus-visible{outline:3px solid var(--focus); outline-offset:2px}

    .grid{display:grid; gap:16px}
    .two{grid-template-columns:1fr}
    @media(min-width:920px){ .two{grid-template-columns:2fr 1fr} }

    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:18px; box-shadow:0 2px 12px rgba(0,0,0,.04)}
    .card h2{margin:0 0 8px 0; font-size:18px}

    .muted{color:var(--muted)}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; background:#eef2ff; border:1px solid #c7d2fe; padding:2px 6px; border-radius:6px}

    label{font-weight:600; display:block; margin:.6rem 0 .3rem}
    input[type="text"], input[type="number"], input[type="url"], input[type="date"], textarea, select{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#fff; color:var(--text);
    }
    textarea{min-height:110px}

    .row{display:flex; gap:8px; align-items:center}
    .row > *{flex:1}

    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#eef1f7; border:1px solid var(--border); margin:4px 6px 0 0}
    .pill button{border:none; background:transparent; cursor:pointer}

    .list{display:grid; gap:12px}
    .list .item{padding:12px; border:1px solid var(--border); border-radius:12px; background:#fff; display:flex; justify-content:space-between; align-items:center; gap:10px}
    .list .item .meta{font-size:12px; color:var(--muted)}

    .sidebar{position:sticky; top:112px; align-self:start}

    .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:8px 0 12px}

    .divider{height:1px; background:var(--border); margin:12px 0}

    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}

    dialog{border:none; padding:0; border-radius:16px; width:min(720px,92vw); box-shadow:0 25px 60px rgba(0,0,0,.2)}
    dialog::backdrop{background:rgba(11,30,63,.6)}
    .modal{padding:16px}

    .tag-input{display:flex; flex-wrap:wrap; gap:6px; padding:8px; border:1px solid var(--border); border-radius:12px; background:#fff}
    .tag-input input{border:none; outline:none; flex:1; min-width:120px}

    .help{font-size:12px; color:var(--muted)}

    .empty{padding:20px; text-align:center; color:var(--muted)}
  </style>
</head>
<body>
  <header role="banner">
    <div class="container">
      <div class="brand" aria-label="App brand">
        <span class="mark" aria-hidden="true"></span>
        <h1>Personal Reference Manager</h1>
      </div>
      <nav aria-label="Primary">
        <button class="btn ghost" data-nav="home" aria-current="page">Home</button>
        <button class="btn ghost" data-nav="add">Add Reference</button>
        <button class="btn ghost" data-nav="library">Search & Library</button>
      </nav>
    </div>
  </header>

  <main class="container" id="app" tabindex="-1">
    <!-- Views are injected here -->
  </main>

  <dialog id="viewDialog" aria-label="Reference details">
    <div class="modal">
      <div class="row" style="justify-content:space-between; align-items:center">
        <h2 id="detailTitle" style="margin:4px 0">Reference</h2>
        <div class="row" style="justify-content:flex-end; gap:8px; flex:0 0 auto">
          <button class="btn secondary" id="editRefBtn">Edit</button>
          <button class="btn danger" id="deleteRefBtn">Delete</button>
          <button class="btn" onclick="closeDialog('viewDialog')" aria-label="Close">Close</button>
        </div>
      </div>
      <div id="detailBody" class="card" style="margin-top:8px"></div>
    </div>
  </dialog>

  <dialog id="confirmDialog" aria-label="Confirm action">
    <div class="modal">
      <h2 style="margin:4px 0">Please confirm</h2>
      <p id="confirmText"></p>
      <div class="row" style="justify-content:flex-end">
        <button class="btn" onclick="closeDialog('confirmDialog')">Cancel</button>
        <button class="btn danger" id="confirmYes">Yes, delete</button>
      </div>
    </div>
  </dialog>

  <div class="sr-only" aria-live="polite" id="live"></div>

  <script>
  /*********************** Data & Utilities ************************/
  const STORE_KEY = 'prm.references.v1';
  const navButtons = () => document.querySelectorAll('[data-nav]');

  const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

  function saveAll(arr){
    localStorage.setItem(STORE_KEY, JSON.stringify(arr));
  }
  function loadAll(){
    try{ return JSON.parse(localStorage.getItem(STORE_KEY)) || []; }catch{ return [] }
  }
  function announce(msg){
    const live = document.getElementById('live');
    live.textContent = msg;
  }
  function setHash(hash){ location.hash = hash; }

  const TYPES = [
    {id:'journal', name:'Journal article'},
    {id:'book', name:'Book'},
    {id:'chapter', name:'Book chapter'},
    {id:'website', name:'Web page'},
    {id:'report', name:'Report'}
  ];

  function formatAuthorHarvard(author){
    // {first, last}
    const initials = (author.first||'').split(/[\s-]+/).filter(Boolean).map(s=>s[0]?.toUpperCase()).join('');
    return `${author.last||''}, ${initials}.`;
  }
  function formatAuthorsList(authors){
    if(!authors || !authors.length) return '';
    if(authors.length===1) return formatAuthorHarvard(authors[0]);
    if(authors.length===2) return `${formatAuthorHarvard(authors[0])} and ${formatAuthorHarvard(authors[1])}`;
    return authors.map((a,i)=> i<authors.length-1 ? formatAuthorHarvard(a) : `and ${formatAuthorHarvard(a)}`).join(', ');
  }
  function inTextCitation(ref){
    // (Name, Year)
    const first = ref.authors?.[0]?.last || 'Anon';
    return `(${first}, ${ref.year||'n.d.'})`;
  }
  function titleCase(s){ return (s||'').replace(/\s+/g,' ').trim(); }

  function formatHarvard(ref){
    const A = formatAuthorsList(ref.authors);
    const Y = ref.year || 'n.d.';
    const T = ref.title ? `<i>${ref.title}</i>` : '';
    const DOI = ref.doi ? ` doi:${ref.doi}` : '';
    const URL = ref.url ? ` Available at: ${ref.url}${ref.accessed ? ` (Accessed: ${ref.accessed})` : ''}` : '';

    switch(ref.type){
      case 'journal':{
        const J = ref.journal || '';
        const V = ref.volume ? `, ${ref.volume}` : '';
        const I = ref.issue ? `(${ref.issue})` : '';
        const P = ref.pages ? `, pp. ${ref.pages}` : '';
        return `${A} (${Y}) ${ref.title}. <i>${J}</i>${V}${I}${P}.${DOI || URL}`.trim();
      }
      case 'book':{
        const Ed = ref.edition ? `${ref.edition} edn. ` : '';
        const Pl = ref.place ? `${ref.place}: ` : '';
        const Pub = ref.publisher || '';
        return `${A} (${Y}) <i>${ref.title}</i>. ${Ed}${Pl}${Pub}.` + (DOI || URL);
      }
      case 'chapter':{
        const Eds = ref.editors?.length ? ` In: ${formatAuthorsList(ref.editors)} (eds) <i>${ref.bookTitle||''}</i>` : ` In: <i>${ref.bookTitle||''}</i>`;
        const Pl = ref.place ? `${ref.place}: ` : '';
        const Pub = ref.publisher || '';
        const P = ref.pages ? `, pp. ${ref.pages}` : '';
        return `${A} (${Y}) ${ref.title}.${Eds}. ${Pl}${Pub}${P}.` + (DOI || URL);
      }
      case 'website':{
        return `${A} (${Y}) ${T}. Available at: ${ref.url||''}${ref.accessed ? ` (Accessed: ${ref.accessed})` : ''}.`;
      }
      case 'report':{
        const Pub = ref.publisher || '';
        return `${A} (${Y}) <i>${ref.title}</i>. ${Pub}.` + (DOI || URL);
      }
      default:
        return `${A} (${Y}) ${T}.` + (DOI || URL);
    }
  }

  /*********************** Routing ************************/
  const routes = {
    home: renderHome,
    add: renderAdd,
    library: renderLibrary
  };
  function navigate(){
    const hash = (location.hash.replace('#','')||'home');
    navButtons().forEach(b=> b.dataset.nav===hash ? b.setAttribute('aria-current','page') : b.removeAttribute('aria-current'));
    routes[hash]?.();
    document.getElementById('app').focus();
  }
  window.addEventListener('hashchange', navigate);
  document.addEventListener('DOMContentLoaded', () => {
    navButtons().forEach(btn=> btn.addEventListener('click',()=> setHash(btn.dataset.nav)));
    navigate();
  });

  /*********************** Views ************************/
  function renderHome(){
    const el = document.getElementById('app');
    el.innerHTML = `
      <section class="grid two">
        <div class="card" role="region" aria-label="Welcome">
          <h2>Welcome</h2>
          <p class="muted">A lightweight, accessible reference manager for your readings. Save items in Harvard style, add notes & quotes, and search later.</p>
          <div class="divider"></div>
          <div class="toolbar">
            <button class="btn primary" onclick="setHash('add')">Start adding references</button>
            <button class="btn secondary" onclick="setHash('library')">Go to your library</button>
          </div>
          <p class="help">Your entries are saved in your browser (local storage) for future use.</p>
        </div>
        <div class="card" role="region" aria-label="Tips">
          <h2>Tips</h2>
          <ul>
            <li>Use the <span class="kbd">Tab</span> key to navigate fields.</li>
            <li>Add multiple authors, quotes (with pages), and tags.</li>
            <li>Use the search page to filter by author, year, tag, or journal.</li>
          </ul>
        </div>
      </section>
    `;
  }

  function renderAdd(existing){
    const ref = existing || {
      id: uid(),
      type: 'journal',
      title: '',
      year: '',
      authors: [{first:'', last:''}],
      editors: [],
      journal: '',
      volume: '',
      issue: '',
      pages: '',
      doi: '',
      url: '',
      accessed: '',
      publisher: '',
      place: '',
      edition: '',
      bookTitle: '',
      review: '',
      quotes: [], // {text,page}
      tags: []
    };

    const el = document.getElementById('app');
    el.innerHTML = `
      <section class="grid two">
        <form class="card" id="refForm" novalidate>
          <h2>${existing? 'Edit reference' : 'Add a reference'}</h2>
          <div class="row">
            <div>
              <label for="type">Source type</label>
              <select id="type" name="type" aria-describedby="typeHelp">
                ${TYPES.map(t=>`<option value="${t.id}">${t.name}</option>`).join('')}
              </select>
              <div class="help" id="typeHelp">Fields change based on type.</div>
            </div>
            <div>
              <label for="year">Year</label>
              <input id="year" name="year" type="number" inputmode="numeric" placeholder="2023" />
            </div>
          </div>

          <label>Authors</label>
          <div id="authors"></div>
          <div class="toolbar">
            <button class="btn secondary" type="button" id="addAuthor">Add author</button>
          </div>

          <div id="typeFields"></div>

          <label for="title">Title</label>
          <input id="title" name="title" type="text" placeholder="Article / Book / Chapter title" />

          <label for="review">Review / Notes</label>
          <textarea id="review" name="review" placeholder="Your summary, critique, or key points..."></textarea>

          <label>Quotes</label>
          <div id="quotes"></div>
          <div class="toolbar">
            <button class="btn secondary" type="button" id="addQuote">Add quote</button>
          </div>

          <label>Tags</label>
          <div class="tag-input" id="tagInput" aria-label="Tags input">
            <input type="text" id="tagField" placeholder="Type a tag and press Enter" />
          </div>
          <div class="help">Examples: theory, methods, climate, ethics</div>

          <div class="divider"></div>
          <div class="row" style="justify-content:space-between">
            <button class="btn" type="button" onclick="setHash('home')">Cancel</button>
            <div class="row" style="flex:0 0 auto">
              ${existing ? '<button class="btn secondary" type="button" id="duplicateBtn">Duplicate</button>' : ''}
              <button class="btn primary" type="submit">${existing? 'Save changes' : 'Save reference'}</button>
            </div>
          </div>
        </form>

        <aside class="card" aria-label="Harvard preview">
          <h2>Harvard reference preview</h2>
          <p id="harvardPreview" class="muted">Fill in the form to see the formatted reference.</p>
          <div class="divider"></div>
          <h2>In-text citation</h2>
          <p id="inTextPreview" class="muted">(Surname, Year)</p>
        </aside>
      </section>
    `;

    // populate
    document.getElementById('type').value = ref.type;
    document.getElementById('year').value = ref.year;
    document.getElementById('title').value = ref.title;
    document.getElementById('review').value = ref.review;

    // authors
    const authorsEl = document.getElementById('authors');
    function renderAuthors(){
      authorsEl.innerHTML = '';
      (ref.authors||[]).forEach((a,idx)=>{
        const row = document.createElement('div'); row.className='row'; row.style.marginBottom='8px';
        row.innerHTML = `
          <input type="text" placeholder="First name(s)" value="${a.first||''}" aria-label="Author ${idx+1} first name"/>
          <input type="text" placeholder="Surname" value="${a.last||''}" aria-label="Author ${idx+1} surname"/>
          <button class="btn secondary" type="button" aria-label="Remove author ${idx+1}">Remove</button>
        `;
        const [first,last,btn] = row.querySelectorAll('input,button');
        first.addEventListener('input', e=> { a.first = e.target.value; updatePreview(); });
        last.addEventListener('input', e=> { a.last = e.target.value; updatePreview(); });
        btn.addEventListener('click', ()=> { ref.authors.splice(idx,1); if(!ref.authors.length) ref.authors.push({first:'',last:''}); renderAuthors(); updatePreview(); });
        authorsEl.appendChild(row);
      });
    }
    document.getElementById('addAuthor').addEventListener('click', ()=>{ ref.authors.push({first:'', last:''}); renderAuthors(); });
    renderAuthors();

    // quotes
    const quotesEl = document.getElementById('quotes');
    function renderQuotes(){
      quotesEl.innerHTML = '';
      (ref.quotes||[]).forEach((q,idx)=>{
        const block = document.createElement('div'); block.className='card';
        block.innerHTML = `
          <label class="sr-only">Quote ${idx+1}</label>
          <textarea placeholder="Quote text">${q.text||''}</textarea>
          <div class="row">
            <input type="text" placeholder="Page(s) e.g. 12 or 12-14" value="${q.page||''}" aria-label="Quote page"/>
            <button class="btn secondary" type="button">Remove quote</button>
          </div>
        `;
        const [ta, pg, rm] = block.querySelectorAll('textarea,input,button');
        ta.addEventListener('input', e=> { q.text = e.target.value; });
        pg.addEventListener('input', e=> { q.page = e.target.value; });
        rm.addEventListener('click', ()=>{ ref.quotes.splice(idx,1); renderQuotes(); });
        quotesEl.appendChild(block);
      });
    }
    document.getElementById('addQuote').addEventListener('click', ()=>{ ref.quotes.push({text:'', page:''}); renderQuotes(); });
    renderQuotes();

    // tags
    const tagInput = document.getElementById('tagInput');
    const tagField = document.getElementById('tagField');
    function renderTags(){
      [...tagInput.querySelectorAll('.pill')].forEach(p=>p.remove());
      (ref.tags||[]).forEach((t,idx)=>{
        const pill = document.createElement('span'); pill.className='pill'; pill.innerHTML = `${t} <button aria-label="Remove ${t}">×</button>`;
        pill.querySelector('button').addEventListener('click', ()=>{ ref.tags.splice(idx,1); renderTags(); });
        tagInput.insertBefore(pill, tagField);
      });
    }
    function addTagFromField(){
      const val = tagField.value.trim();
      if(val && !ref.tags.includes(val)) { ref.tags.push(val); tagField.value=''; renderTags(); }
    }
    tagField.addEventListener('keydown', e=>{
      if(e.key==='Enter' || e.key===','){ e.preventDefault(); addTagFromField(); }
      if(e.key==='Backspace' && !tagField.value && ref.tags.length){ ref.tags.pop(); renderTags(); }
    });
    tagField.addEventListener('blur', addTagFromField);
    renderTags();

    // type-specific fields
    const typeFields = document.getElementById('typeFields');
    function drawTypeFields(){
      const t = ref.type;
      let html = '';
      if(t==='journal'){
        html = `
          <div class="row">
            <div>
              <label for="journal">Journal</label>
              <input id="journal" type="text" placeholder="e.g. Nature" />
            </div>
            <div>
              <label for="volume">Volume</label>
              <input id="volume" type="text" placeholder="e.g. 12" />
            </div>
          </div>
          <div class="row">
            <div>
              <label for="issue">Issue</label>
              <input id="issue" type="text" placeholder="e.g. 3" />
            </div>
            <div>
              <label for="pages">Pages</label>
              <input id="pages" type="text" placeholder="e.g. 123-147" />
            </div>
          </div>
        `;
      } else if(t==='book'){
        html = `
          <div class="row">
            <div>
              <label for="edition">Edition</label>
              <input id="edition" type="text" placeholder="e.g. 2nd" />
            </div>
            <div>
              <label for="publisher">Publisher</label>
              <input id="publisher" type="text" placeholder="e.g. Routledge" />
            </div>
          </div>
          <div class="row">
            <div>
              <label for="place">Place</label>
              <input id="place" type="text" placeholder="e.g. London" />
            </div>
          </div>
        `;
      } else if(t==='chapter'){
        html = `
          <div class="row">
            <div>
              <label for="bookTitle">Book title (container)</label>
              <input id="bookTitle" type="text" placeholder="e.g. Handbook of X" />
            </div>
            <div>
              <label for="pages">Pages</label>
              <input id="pages" type="text" placeholder="e.g. 45-62" />
            </div>
          </div>
          <label>Editors</label>
          <div id="editors"></div>
          <div class="toolbar">
            <button class="btn secondary" type="button" id="addEditor">Add editor</button>
          </div>
          <div class="row">
            <div>
              <label for="publisher">Publisher</label>
              <input id="publisher" type="text" placeholder="e.g. Sage" />
            </div>
            <div>
              <label for="place">Place</label>
              <input id="place" type="text" placeholder="e.g. London" />
            </div>
          </div>
        `;
      } else if(t==='website'){
        html = `
          <div class="row">
            <div>
              <label for="url">URL</label>
              <input id="url" type="url" placeholder="https://..." />
            </div>
            <div>
              <label for="accessed">Accessed date</label>
              <input id="accessed" type="date" />
            </div>
          </div>
        `;
      } else if(t==='report'){
        html = `
          <div class="row">
            <div>
              <label for="publisher">Publisher / Institution</label>
              <input id="publisher" type="text" placeholder="e.g. WHO" />
            </div>
          </div>
        `;
      }
      // common identifiers
      html += `
        <div class="row">
          <div>
            <label for="doi">DOI</label>
            <input id="doi" type="text" placeholder="10.1234/abcd" />
          </div>
          ${t!=='website' ? `
          <div>
            <label for="url">URL</label>
            <input id="url" type="url" placeholder="https://..." />
          </div>` : ''}
        </div>`;

      typeFields.innerHTML = html;

      // attach editor controls if chapter
      if(t==='chapter'){
        const edWrap = document.getElementById('editors');
        function renderEditors(){
          edWrap.innerHTML='';
          (ref.editors||[]).forEach((e,idx)=>{
            const row = document.createElement('div'); row.className='row'; row.style.marginBottom='8px';
            row.innerHTML = `
              <input type="text" placeholder="First name(s)" value="${e.first||''}" aria-label="Editor ${idx+1} first name"/>
              <input type="text" placeholder="Surname" value="${e.last||''}" aria-label="Editor ${idx+1} surname"/>
              <button class="btn secondary" type="button">Remove</button>`;
            const [f,l,rm] = row.querySelectorAll('input,button');
            f.addEventListener('input', ev=>{ e.first = ev.target.value; updatePreview(); });
            l.addEventListener('input', ev=>{ e.last = ev.target.value; updatePreview(); });
            rm.addEventListener('click', ()=>{ ref.editors.splice(idx,1); renderEditors(); updatePreview(); });
            edWrap.appendChild(row);
          });
        }
        document.getElementById('addEditor').addEventListener('click', ()=>{ ref.editors.push({first:'', last:''}); renderEditors(); });
        renderEditors();
      }

      // wire common field sync
      ['journal','volume','issue','pages','doi','url','accessed','publisher','place','edition','bookTitle']
        .forEach(id=>{ const el = document.getElementById(id); if(!el) return; el.value = ref[id]||''; el.addEventListener('input', e=>{ ref[id]=e.target.value; updatePreview(); }); });
    }

    drawTypeFields();

    // sync basic fields
    document.getElementById('type').addEventListener('change', e=>{ ref.type=e.target.value; drawTypeFields(); updatePreview(); });
    document.getElementById('year').addEventListener('input', e=>{ ref.year=e.target.value; updatePreview(); });
    document.getElementById('title').addEventListener('input', e=>{ ref.title=e.target.value; updatePreview(); });
    document.getElementById('review').addEventListener('input', e=>{ ref.review=e.target.value; });

    function updatePreview(){
      document.getElementById('harvardPreview').innerHTML = formatHarvard(ref);
      document.getElementById('inTextPreview').textContent = `${inTextCitation(ref)} - ${ref.title||''}`;
    }
    updatePreview();

    // submit
    document.getElementById('refForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const all = loadAll();
      const existsIndex = all.findIndex(x=> x.id===ref.id);
      if(existsIndex>=0){ all[existsIndex] = {...ref, updatedAt: Date.now()}; announce('Reference updated'); }
      else { all.push({...ref, createdAt: Date.now()}); announce('Reference saved'); }
      saveAll(all);
      setHash('library');
    });

    // duplicate button
    const dup = document.getElementById('duplicateBtn');
    if(dup){ dup.addEventListener('click', ()=>{ const copy = JSON.parse(JSON.stringify(ref)); copy.id = uid(); copy.title += ' (copy)'; renderAdd(copy); announce('Duplicated'); }); }

    // preload existing
    if(existing){
      // fields already set via value assignments
    }
  }

  function renderLibrary(){
    const el = document.getElementById('app');
    const refs = loadAll();

    el.innerHTML = `
      <section class="grid two">
        <aside class="sidebar card" aria-label="Filters">
          <h2>Filters</h2>
          <div id="filters"></div>
          <div class="divider"></div>
          <button class="btn" id="clearFilters">Clear filters</button>
        </aside>

        <section>
          <div class="card" role="search">
            <h2>Search</h2>
            <input type="text" id="search" placeholder="Type to search... (title, review, quotes)" aria-describedby="searchHelp" />
            <div id="searchHelp" class="help">Returns three groups: matches in title, review, and quotes.</div>
            <div class="toolbar">
              <button class="btn secondary" id="newRef">Add new reference</button>
              <button class="btn" id="exportBtn" title="Export JSON">Export</button>
              <input type="file" id="importFile" accept="application/json" aria-label="Import JSON" style="display:none"/>
              <button class="btn" id="importBtn" title="Import JSON">Import</button>
            </div>
          </div>

          <div class="card" id="defaultList">
            <h2>All references</h2>
            <div id="list" class="list"></div>
            <div class="empty" id="emptyMsg" hidden>No references yet. Click “Add new reference”.</div>
          </div>

          <div class="card" id="searchResults" hidden>
            <h2>Search results</h2>
            <div class="grid" style="grid-template-columns:1fr; gap:18px">
              <div>
                <h3>Matches in title</h3>
                <div id="resTitle" class="list"></div>
              </div>
              <div>
                <h3>Matches in review</h3>
                <div id="resReview" class="list"></div>
              </div>
              <div>
                <h3>Matches in quotes</h3>
                <div id="resQuotes" class="list"></div>
              </div>
            </div>
          </div>
        </section>
      </section>
    `;

    document.getElementById('newRef').addEventListener('click', ()=> setHash('add'));

    // Export/Import
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const data = JSON.stringify(loadAll(), null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'references.json'; a.click(); URL.revokeObjectURL(url);
    });
    document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importFile').click());
    document.getElementById('importFile').addEventListener('change', (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{ try{
        const arr = JSON.parse(reader.result);
        if(Array.isArray(arr)) { saveAll(arr); announce('Imported references'); renderLibrary(); }
        else alert('Invalid JSON');
      } catch(err){ alert('Failed to import: '+err.message); }
      };
      reader.readAsText(file);
    });

    // Populate filters
    const filtersEl = document.getElementById('filters');
    const authors = [...new Set(refs.flatMap(r=> (r.authors||[]).map(a=> a.last).filter(Boolean)))].sort();
    const years = [...new Set(refs.map(r=> r.year).filter(Boolean))].map(Number).sort((a,b)=>a-b);
    const tags = [...new Set(refs.flatMap(r=> r.tags||[]))].sort();
    const journals = [...new Set(refs.map(r=> r.journal).filter(Boolean))].sort();

    filtersEl.innerHTML = `
      <fieldset>
        <legend>Authors</legend>
        ${authors.length? authors.map(a=> `<label class="row"><input type="checkbox" value="${a}"/> <span>${a}</span></label>`).join('') : '<p class="muted">No authors yet</p>'}
      </fieldset>
      <div class="divider"></div>
      <fieldset>
        <legend>Year</legend>
        <div class="row">
          <input type="number" id="yFrom" placeholder="From" />
          <input type="number" id="yTo" placeholder="To" />
        </div>
      </fieldset>
      <div class="divider"></div>
      <fieldset>
        <legend>Tags</legend>
        ${tags.length? tags.map(t=> `<label class="row"><input type="checkbox" value="${t}"/> <span>${t}</span></label>`).join('') : '<p class="muted">No tags yet</p>'}
      </fieldset>
      <div class="divider"></div>
      <fieldset>
        <legend>Journals</legend>
        ${journals.length? journals.map(j=> `<label class="row"><input type="checkbox" value="${j}"/> <span>${j}</span></label>`).join('') : '<p class="muted">No journals yet</p>'}
      </fieldset>
    `;

    function getFilterState(){
      const chosenAuthors = [...filtersEl.querySelectorAll('fieldset:nth-of-type(1) input:checked')].map(i=>i.value);
      const yFrom = Number(document.getElementById('yFrom').value)||-Infinity;
      const yTo = Number(document.getElementById('yTo').value)||Infinity;
      const chosenTags = [...filtersEl.querySelectorAll('fieldset:nth-of-type(3) input:checked')].map(i=>i.value);
      const chosenJournals = [...filtersEl.querySelectorAll('fieldset:nth-of-type(4) input:checked')].map(i=>i.value);
      return {chosenAuthors, yFrom, yTo, chosenTags, chosenJournals};
    }

    function applyFilters(items){
      const {chosenAuthors,yFrom,yTo,chosenTags,chosenJournals} = getFilterState();
      return items.filter(r=>{
        const lastNames = (r.authors||[]).map(a=>a.last);
        const authorOK = !chosenAuthors.length || chosenAuthors.some(a=> lastNames.includes(a));
        const yearOK = !r.year || (Number(r.year) >= yFrom && Number(r.year) <= yTo);
        const tagOK = !chosenTags.length || (r.tags||[]).some(t=> chosenTags.includes(t));
        const journalOK = !chosenJournals.length || chosenJournals.includes(r.journal);
        return authorOK && yearOK && tagOK && journalOK;
      });
    }

    filtersEl.addEventListener('change', ()=> renderList());
    document.getElementById('yFrom').addEventListener('input', ()=> renderList());
    document.getElementById('yTo').addEventListener('input', ()=> renderList());
    document.getElementById('clearFilters').addEventListener('click', ()=>{ filtersEl.querySelectorAll('input').forEach(i=>{ if(i.type==='checkbox') i.checked=false; else i.value=''; }); renderList(); });

    function shortLine(r){
      return `${inTextCitation(r)} - ${r.title || ''}`;
    }

    function itemRow(r){
      const div = document.createElement('div'); div.className='item';
      const left = document.createElement('div');
      left.innerHTML = `<div>${shortLine(r)}</div><div class="meta">${r.type} • ${r.journal||r.publisher||''}</div>`;
      const right = document.createElement('div'); right.style.flex='0 0 auto'; right.className='row';
      const view = document.createElement('button'); view.className='btn secondary'; view.textContent='Open'; view.addEventListener('click', ()=> openDetail(r.id));
      const edit = document.createElement('button'); edit.className='btn secondary'; edit.textContent='Edit'; edit.addEventListener('click', ()=> editRef(r.id));
      const del = document.createElement('button'); del.className='btn danger'; del.textContent='Delete'; del.addEventListener('click', ()=> confirmDelete(r.id));
      right.append(view, edit, del);
      div.append(left, right);
      return div;
    }

    function renderList(){
      const list = document.getElementById('list');
      const items = applyFilters(refs).sort((a,b)=> (b.year||0)-(a.year||0));
      list.innerHTML='';
      if(!items.length){ document.getElementById('emptyMsg').hidden=false; }
      else { document.getElementById('emptyMsg').hidden=true; items.forEach(r=> list.appendChild(itemRow(r))); }
    }
    renderList();

    // search behaviour
    const search = document.getElementById('search');
    const resultsWrap = document.getElementById('searchResults');
    const defaultList = document.getElementById('defaultList');

    function doSearch(){
      const q = search.value.trim().toLowerCase();
      if(!q){ resultsWrap.hidden = true; defaultList.hidden = false; return; }
      resultsWrap.hidden = false; defaultList.hidden = true;
      const filtered = applyFilters(refs);
      const title = filtered.filter(r=> (r.title||'').toLowerCase().includes(q));
      const review = filtered.filter(r=> (r.review||'').toLowerCase().includes(q));
      const quotes = filtered.filter(r=> (r.quotes||[]).some(qu=> (qu.text||'').toLowerCase().includes(q)));
      const fill = (id, arr)=>{
        const box = document.getElementById(id); box.innerHTML='';
        if(!arr.length){ box.innerHTML = '<div class="empty">No matches</div>'; return; }
        arr.forEach(r=> box.appendChild(itemRow(r)));
      };
      fill('resTitle', title);
      fill('resReview', review);
      fill('resQuotes', quotes);
    }
    search.addEventListener('input', doSearch);
  }

  /*********************** Detail / Edit / Delete ************************/
  function openDetail(id){
    const ref = loadAll().find(r=> r.id===id); if(!ref) return;
    const body = document.getElementById('detailBody');
    document.getElementById('detailTitle').textContent = ref.title || 'Reference';
    const authors = formatAuthorsList(ref.authors);
    const tags = (ref.tags||[]).map(t=> `<span class="pill" aria-hidden="true">${t}</span>`).join(' ');
    const quotes = (ref.quotes||[]).map(q=> `<li>“${q.text}” <span class="meta">(p. ${q.page||'—'})</span></li>`).join('');
    body.innerHTML = `
      <p><strong>Harvard:</strong> ${formatHarvard(ref)}</p>
      <div class="divider"></div>
      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div>
          <p><strong>Type:</strong> ${ref.type}</p>
          <p><strong>Authors:</strong> ${authors||'—'}</p>
          <p><strong>Year:</strong> ${ref.year||'—'}</p>
          <p><strong>Title:</strong> ${ref.title||'—'}</p>
          <p><strong>Journal/Publisher:</strong> ${ref.journal||ref.publisher||'—'}</p>
          <p><strong>Volume(Issue):</strong> ${(ref.volume||'')}${ref.issue? '('+ref.issue+')':''}</p>
          <p><strong>Pages:</strong> ${ref.pages||'—'}</p>
          <p><strong>DOI/URL:</strong> ${ref.doi||ref.url||'—'}</p>
        </div>
        <div>
          <p><strong>Tags:</strong> ${tags||'—'}</p>
          <p><strong>In-text:</strong> ${inTextCitation(ref)} - ${ref.title||''}</p>
          <p><strong>Review/Notes:</strong></p>
          <p>${(ref.review||'—').replace(/\n/g,'<br>')}</p>
          <p><strong>Quotes:</strong></p>
          <ul>${quotes||'<li class="meta">No quotes</li>'}</ul>
        </div>
      </div>
    `;
    const dlg = document.getElementById('viewDialog');
    dlg.showModal();
    document.getElementById('editRefBtn').onclick = ()=>{ dlg.close(); editRef(id); };
    document.getElementById('deleteRefBtn').onclick = ()=>{ dlg.close(); confirmDelete(id); };
  }

  function editRef(id){
    const ref = loadAll().find(r=> r.id===id); if(!ref) return;
    setHash('add');
    // Wait for view to render, then inject existing
    setTimeout(()=> renderAdd(ref), 0);
  }

  function confirmDelete(id){
    const dlg = document.getElementById('confirmDialog');
    document.getElementById('confirmText').textContent = 'This will permanently delete the reference.';
    dlg.showModal();
    document.getElementById('confirmYes').onclick = ()=>{
      const all = loadAll().filter(r=> r.id!==id); saveAll(all); dlg.close(); announce('Reference deleted');
      if(document.getElementById('viewDialog').open) document.getElementById('viewDialog').close();
      setHash('library');
    };
  }
  function closeDialog(id){ document.getElementById(id).close(); }
  </script>
</body>
</html>
